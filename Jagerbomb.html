<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compteur de J√§gerbombs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #18181b; /* Zinc-900 pour un fond sombre */
            color: #d4d4d8; /* Zinc-300 pour le texte clair */
            overflow-x: hidden; /* Emp√™che le d√©filement horizontal */
            padding: 1rem; /* Ajoute un padding global pour ne pas coller les bords */
        }

        /* Styles pour les particules d'emoji/confettis */
        .confetti-emoji {
            position: absolute;
            font-size: 2rem; /* Taille des emojis */
            opacity: 0;
            animation: confetti-burst 2s forwards ease-out; /* Dur√©e de l'animation */
            pointer-events: none; /* Permet de cliquer √† travers les emojis */
        }

        @keyframes confetti-burst {
            0% {
                opacity: 1;
                transform: translate(0, 0) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translate(var(--x), var(--y)) rotate(var(--rotate));
            }
        }

        /* Animation pour l'overlay de c√©l√©bration ultime */
        @keyframes pulse-bg {
            0% { background-color: #dc2626; } /* Red-600 */
            50% { background-color: #ea580c; } /* Orange-600 */
            100% { background-color: #dc2626; }
        }

        .ultimate-celebration-active {
            animation: pulse-bg 1s infinite alternate;
        }

        /* Styles pour les onglets */
        .tab-button {
            flex-grow: 1; /* Permet aux boutons d'onglets de prendre de l'espace √©gal */
            text-align: center; /* Centrer le texte pour les onglets horizontaux */
            border-bottom: 2px solid transparent; /* Bordure par d√©faut pour le bas (mobile) */
            color: #d4d4d8; /* Couleur de texte par d√©faut */
            padding: 0.75rem 1rem; /* Padding ajust√© */
            white-space: nowrap; /* Emp√™che le texte de se casser sur plusieurs lignes */
        }

        .tab-button.active {
            background-color: #27272a; /* Zinc-800 */
            border-bottom: 2px solid #16a34a; /* Green-600 pour l'onglet actif (mobile) */
            color: #16a34a; /* Green-600 */
        }

        /* Styles sp√©cifiques pour les onglets sur les grands √©crans (lg) */
        @media (min-width: 1024px) {
            .tab-button {
                border-right: 2px solid transparent; /* Bordure par d√©faut pour la droite (desktop) */
                border-bottom: none; /* Supprime la bordure du bas */
                text-align: left; /* Alignement du texte √† gauche sur desktop */
                padding: 0.5rem 1rem; /* Padding ajust√© pour desktop */
                flex-grow: 0; /* Ne pas √©tirer les boutons sur desktop */
            }
            .tab-button.active {
                border-right: 2px solid #16a34a; /* Green-600 pour l'onglet actif (desktop) */
                border-bottom: none; /* Supprime la bordure du bas */
            }
        }

        /* Animation subtile pour le texte des paliers */
        @keyframes milestone-flash {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }
        .milestone-text-active {
            animation: milestone-flash 1s ease-out;
        }

        /* Styles pour l'√©cran Action ou V√©rit√© */
        #actionOrTruthScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9); /* Fond sombre semi-transparent */
            display: none; /* Assurez-vous qu'il est masqu√© par d√©faut via CSS */
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Assure qu'il est au-dessus de tout */
            backdrop-filter: blur(5px); /* Effet de flou sur l'arri√®re-plan */
            padding: 1rem; /* Ajout de padding pour √©viter que le contenu ne touche les bords */
        }

        #actionOrTruthContent {
            background-color: #27272a; /* Zinc-800 */
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 90%; /* Limite la largeur sur mobile */
            width: 500px; /* Largeur max sur desktop */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            transform: scale(0.8);
            opacity: 0;
            animation: popIn 0.3s forwards ease-out;
        }

        @keyframes popIn {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="p-4">
    <div class="flex flex-col items-center justify-center min-h-screen w-full">

        <div id="welcomeScreen" class="bg-zinc-800 p-8 rounded-xl shadow-2xl text-center max-w-sm w-full border border-zinc-700 mx-auto">
            <h1 class="text-4xl sm:text-5xl font-extrabold mb-8 text-green-600">
                Bienvenue √† la soir√©e J√§gerbombs de l'AFEM&Co !
            </h1>
            <p class="text-base sm:text-lg mb-8 text-zinc-300">
                Pr√©parez-vous √† compter vos J√§gerbombs et √† estimer votre alcool√©mie.
            </p>
            <button id="startButton"
                    class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-full shadow-lg transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50">
                Commencer √† faire la f√™te !
            </button>
        </div>

        <div id="objectiveSettingScreen" class="bg-zinc-800 p-8 rounded-xl shadow-2xl text-center max-w-sm w-full border border-zinc-700 mx-auto hidden">
            <h1 class="text-3xl sm:text-4xl font-extrabold mb-6 text-green-600">
                Fixez votre objectif de la soir√©e
            </h1>
            <label for="initialObjectiveInput" class="text-base sm:text-lg mb-2 block">Combien de J√§gerbombs visez-vous ?</label>
            <input type="number" id="initialObjectiveInput" value="50" min="1"
                   class="bg-zinc-700 text-white rounded-md p-2 w-24 sm:w-32 text-center mb-2 focus:outline-none focus:ring-2 focus:ring-green-600">
            <p id="objectiveError" class="text-red-400 text-sm mb-4 hidden">Veuillez entrer un objectif valide (nombre positif).</p>
            <button id="setObjectiveButton"
                    class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 px-6 rounded-full shadow-lg transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-orange-500 focus:ring-opacity-50">
                Valider l'objectif
            </button>
        </div>

        <div id="mainAppScreen" class="flex flex-col items-center lg:flex-row lg:items-start justify-center gap-4 sm:gap-8 p-0 sm:p-4 w-full max-w-6xl mx-auto hidden">
            <div class="bg-zinc-800 p-4 sm:p-8 rounded-xl shadow-2xl w-full border border-zinc-700 relative overflow-hidden flex flex-col">
                <div class="flex flex-row justify-around border-b border-zinc-700 lg:flex-col lg:border-b-0 lg:border-r lg:pr-4 lg:mr-4 lg:w-1/4 pb-2 lg:pb-0">
                    <h1 class="hidden lg:block text-2xl font-extrabold mb-6 text-green-600 text-left">
                        Nombre personnel de J√§gerbombs
                    </h1>
                    <button id="tabCounter" class="tab-button text-sm sm:text-md font-semibold transition-colors duration-200 active">
                        Compteur
                    </button>
                    <button id="tabObjective" class="tab-button text-sm sm:text-md font-semibold transition-colors duration-200">
                        Objectif & Jauge
                    </button>
                    <button id="tabBAC" class="tab-button text-sm sm:text-md font-semibold transition-colors duration-200">
                        Alcool√©mie
                    </button>
                </div>

                <div id="tabContent" class="flex-grow text-center mt-4 lg:mt-0 p-4 sm:p-0">
                    <div id="contentCounter" class="tab-pane">
                        <p class="text-base sm:text-lg mb-4 text-zinc-300">
                            Nombre de J√§gerbombs bu(s) :
                        </p>
                        <div id="countDisplay" class="text-6xl sm:text-7xl font-bold mb-4 text-orange-400">
                            0
                        </div>

                        <div id="nextMilestoneDisplay" class="text-base sm:text-xl font-semibold mb-8 text-zinc-400">
                            Prochain palier : -- J√§gerbombs
                        </div>

                        <button id="incrementButton"
                                class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 sm:py-4 px-6 rounded-full shadow-lg transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50">
                            + 1 J√§gerbomb
                        </button>

                        <div class="grid grid-cols-2 gap-3 sm:gap-4 mt-6">
                            <button id="increment5Button"
                                    class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 sm:py-3 px-4 rounded-full shadow-lg transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-600 focus:ring-opacity-50">
                                + 5
                            </button>
                            <button id="increment10Button"
                                    class="bg-orange-700 hover:bg-orange-800 text-white font-bold py-2 sm:py-3 px-4 rounded-full shadow-lg transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-orange-600 focus:ring-opacity-50">
                                + 10
                            </button>
                            <button id="increment20Button"
                                    class="col-span-2 bg-red-700 hover:bg-red-800 text-white font-bold py-2 sm:py-3 px-4 rounded-full shadow-lg transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-600 focus:ring-opacity-50">
                                + 20
                            </button>
                        </div>

                        <button id="resetButton"
                                class="w-full mt-6 bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-2 sm:py-3 px-6 rounded-full shadow-lg transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-zinc-500 focus:ring-opacity-50">
                            Remise √† z√©ro
                        </button>
                    </div>

                    <div id="contentObjective" class="tab-pane hidden">
                        <label for="objectiveInput" class="text-base sm:text-lg mb-2 block">Objectif J√§gerbombs :</label>
                        <input type="number" id="objectiveInput" value="50" min="1"
                               class="bg-zinc-700 text-white rounded-md p-2 w-24 sm:w-32 text-center mb-6 focus:outline-none focus:ring-2 focus:ring-green-600">

                        <div class="flex flex-col items-center">
                            <p class="text-base sm:text-lg mb-2 text-zinc-300">Progression :</p>
                            <div class="relative w-20 h-48 sm:w-24 sm:h-64 bg-zinc-700 rounded-b-3xl rounded-t-lg overflow-hidden border-2 border-zinc-600">
                                <div class="absolute -top-4 left-1/2 -translate-x-1/2 w-10 h-6 sm:w-12 sm:h-8 bg-zinc-700 rounded-t-lg border-x-2 border-t-2 border-zinc-600"></div>
                                <div class="absolute -top-8 left-1/2 -translate-x-1/2 w-6 h-6 sm:w-8 sm:h-8 bg-zinc-700 rounded-t-lg border-x-2 border-t-2 border-zinc-600"></div>

                                <div id="liquidLevel" class="absolute bottom-0 left-0 w-full bg-green-600 transition-all duration-500 ease-out" style="height: 0%;"></div>

                                <div id="milestone1" class="absolute left-0 w-full h-0.5 bg-orange-400 opacity-75" style="bottom: 0%;"></div>
                                <div id="milestone2" class="absolute left-0 w-full h-0.5 bg-red-400 opacity-75" style="bottom: 0%;"></div>
                                <div id="milestone3" class="absolute left-0 w-full h-0.5 bg-yellow-400 opacity-75" style="bottom: 0%;"></div>

                                <span id="milestone1Text" class="absolute left-full ml-2 text-xs sm:text-sm text-orange-400 font-bold" style="bottom: 0%; display: block;"></span>
                                <span id="milestone2Text" class="absolute left-full ml-2 text-xs sm:text-sm text-red-400 font-bold" style="bottom: 0%; display: block;"></span>
                                <span id="milestone3Text" class="absolute left-full ml-2 text-xs sm:text-sm text-yellow-400 font-bold" style="bottom: 0%; display: block;"></span>
                            </div>
                        </div>
                    </div>

                    <div id="contentBAC" class="tab-pane hidden">
                        <h2 class="text-2xl sm:text-3xl font-extrabold mb-6 text-green-600">
                            Alcool√©mie Estim√©e
                        </h2>
                        <label for="weightInput" class="text-base sm:text-lg mb-2 block">Votre poids (kg) :</label>
                        <input type="number" id="weightInput" value="70" min="1"
                               class="bg-zinc-700 text-white rounded-md p-2 w-24 sm:w-32 text-center mb-6 focus:outline-none focus:ring-2 focus:ring-green-600">

                        <div class="flex items-center justify-center mb-4">
                            <input type="checkbox" id="youngDriverCheckbox" class="form-checkbox h-5 w-5 text-green-600 rounded mr-2">
                            <label for="youngDriverCheckbox" class="text-base sm:text-lg text-zinc-300">Jeune permis (< 3 ans)</label>
                        </div>

                        <p class="text-base sm:text-lg mb-2 text-zinc-300">
                            Alcool√©mie (g/L) :
                        </p>
                        <div id="bacDisplay" class="text-4xl sm:text-5xl font-bold mb-6 text-yellow-400">
                            0.00
                        </div>

                        <p class="text-base sm:text-lg mb-2 text-zinc-300">
                            Statut de conduite :
                        </p>
                        <div id="drivingStatusDisplay" class="text-2xl sm:text-3xl font-bold mb-6">
                            </div>

                        <p class="text-base sm:text-lg mb-2 text-zinc-300">
                            Temps de d√©cuvage estim√© :
                        </p>
                        <div id="soberUpTimeDisplay" class="text-2xl sm:text-3xl font-bold text-blue-400">
                            0h 00m
                        </div>
                        <p class="text-xs sm:text-sm mt-2 text-zinc-400">
                            (Bas√© sur un homme moyen et une √©limination de 0.15 g/L par heure)
                        </p>
                        <p class="text-xs sm:text-sm mt-2 text-zinc-400">
                            Heure estim√©e pour conduire :
                        </p>
                        <div id="driveTimeDisplay" class="text-xl sm:text-2xl font-bold text-green-400">
                            --:--
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="actionOrTruthScreen" style="display: none;">
        <div id="actionOrTruthContent" class="bg-zinc-800 p-6 sm:p-8 rounded-xl shadow-2xl text-center">
            <h2 class="text-3xl sm:text-4xl font-extrabold mb-6 text-green-600">Action ou V√©rit√© ?</h2>
            <p id="challengeDisplay" class="text-xl sm:text-2xl mb-8 text-zinc-300 min-h-[4rem] flex items-center justify-center">
                Choisis ton destin !
            </p>
            <div class="flex flex-col sm:flex-row justify-center gap-4 mb-6">
                <button id="actionButton"
                        class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50">
                    Action
                </button>
                <button id="truthButton"
                        class="w-full sm:w-auto bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-orange-500 focus:ring-opacity-50">
                    V√©rit√©
                </button>
            </div>
            <button id="doneButton"
                    class="w-full bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-zinc-500 focus:ring-opacity-50">
                FAIT !
            </button>
        </div>
    </div>

    <div id="fireworksContainer" class="fixed inset-0 pointer-events-none z-20"></div>

    <div id="ultimateCelebrationOverlay" class="fixed inset-0 flex flex-col items-center justify-center bg-gradient-to-br from-red-800 to-yellow-600 z-30 hidden opacity-0 transition-opacity duration-500 ease-out">
        <h2 class="text-5xl sm:text-7xl font-extrabold mb-8 animate-pulse">OBJECTIF ATTEINT !</h2>
        <p class="text-3xl sm:text-4xl font-bold" id="ultimateCelebrationCount">0 J√§gerbombs !</p>
    </div>

    <script>
        // R√©f√©rences aux √©l√©ments du DOM
        const welcomeScreen = document.getElementById('welcomeScreen');
        const startButton = document.getElementById('startButton');
        const objectiveSettingScreen = document.getElementById('objectiveSettingScreen');
        const initialObjectiveInput = document.getElementById('initialObjectiveInput');
        const setObjectiveButton = document.getElementById('setObjectiveButton');
        const objectiveError = document.getElementById('objectiveError');
        const mainAppScreen = document.getElementById('mainAppScreen');

        const countDisplay = document.getElementById('countDisplay');
        const nextMilestoneDisplay = document.getElementById('nextMilestoneDisplay');
        const incrementButton = document.getElementById('incrementButton');
        const increment5Button = document.getElementById('increment5Button');
        const increment10Button = document.getElementById('increment10Button');
        const increment20Button = document.getElementById('increment20Button');
        const resetButton = document.getElementById('resetButton');
        // const celebrationMessage = document.getElementById('celebrationMessage'); // Removed, not used in HTML
        const objectiveInput = document.getElementById('objectiveInput');
        const liquidLevel = document.getElementById('liquidLevel');
        const fireworksContainer = document.getElementById('fireworksContainer');
        const ultimateCelebrationOverlay = document.getElementById('ultimateCelebrationOverlay');
        const ultimateCelebrationCount = document.getElementById('ultimateCelebrationCount');
        const weightInput = document.getElementById('weightInput');
        const youngDriverCheckbox = document.getElementById('youngDriverCheckbox');
        const bacDisplay = document.getElementById('bacDisplay');
        const drivingStatusDisplay = document.getElementById('drivingStatusDisplay');
        const soberUpTimeDisplay = document.getElementById('soberUpTimeDisplay');
        const driveTimeDisplay = document.getElementById('driveTimeDisplay');

        // R√©f√©rences aux √©l√©ments des paliers de la jauge
        const milestone1 = document.getElementById('milestone1');
        const milestone2 = document.getElementById('milestone2');
        const milestone3 = document.getElementById('milestone3');
        const milestone1Text = document.getElementById('milestone1Text');
        const milestone2Text = document.getElementById('milestone2Text');
        const milestone3Text = document.getElementById('milestone3Text');

        // R√©f√©rences aux boutons et contenus des onglets
        const tabCounter = document.getElementById('tabCounter');
        const tabObjective = document.getElementById('tabObjective');
        const tabBAC = document.getElementById('tabBAC');
        const contentCounter = document.getElementById('contentCounter');
        const contentObjective = document.getElementById('contentObjective');
        const contentBAC = document.getElementById('contentBAC');

        // R√©f√©rences pour l'√©cran Action ou V√©rit√©
        const actionOrTruthScreen = document.getElementById('actionOrTruthScreen');
        const actionButton = document.getElementById('actionButton');
        const truthButton = document.getElementById('truthButton');
        const challengeDisplay = document.getElementById('challengeDisplay');
        const doneButton = document.getElementById('doneButton');

        // Initialisation du compteur et de l'objectif
        let jagerbombCount = 0;
        let previousJagerbombCount = 0;
        let objective = 50;

        // Flags pour suivre si les paliers de la jauge ont √©t√© atteints pour la c√©l√©bration
        let milestone1Reached = false;
        let milestone2Reached = false;
        let milestone3Reached = false;

        // Constantes pour le calcul d'alcool√©mie
        const JAG_ML = 45;
        const JAG_ABV = 0.35;
        const ETHANOL_DENSITY = 0.789;
        const MALE_R_FACTOR = 0.68;
        const ELIMINATION_RATE = 0.15;

        // Limites l√©gales d'alcool√©mie en g/L
        const LEGAL_LIMIT_STANDARD = 0.5;
        const LEGAL_LIMIT_YOUNG_DRIVER = 0.2;

        // Base de donn√©es d'actions et de v√©rit√©s (MISES √Ä JOUR)
        const actions = [
            "Fais un dab g√©ant et crie 'J√§ger time !'",
            "Imite le cri d'un animal de la jungle en buvant ton prochain J√§gerbomb.",
            "Danse la Macarena √† l'envers pendant 30 secondes.",
            "Fais un selfie avec la personne la plus 'chill' de la soir√©e et montre-le.",
            "Chante une chanson de Disney avec la voix la plus aigu√´ possible.",
            "√âchange tes chaussettes avec quelqu'un d'autre (si tu en portes).",
            "Fais une d√©claration d'amour passionn√©e √† un objet al√©atoire (ex: une chaise, une plante).",
            "Tente de faire tenir une cuill√®re sur ton nez pendant 10 secondes.",
            "Parle en rimes jusqu'√† ton prochain J√§gerbomb.",
            "Fais le bruit d'une sir√®ne de police en courant sur place.",
            "Demande √† quelqu'un de te faire un compliment absurde.",
            "Fais un 'air guitar' √©pique sur une musique imaginaire.",
            "√âcris ton nom avec tes fesses dans l'air, sans les mains.",
            "Fais une imitation de ton professeur le plus ennuyeux.",
            "Essaie de l√©cher ton coude (sans tricher !).",
            "Fais un high-five avec 5 personnes diff√©rentes en moins de 10 secondes.",
            "Raconte une blague tellement nulle qu'elle en devient dr√¥le.",
            "Fais 10 pas de danse al√©atoires et ridicules.",
            "Demande √† quelqu'un de te donner un d√©fi, et ex√©cute-le (dans la limite du raisonnable).",
            "Fais une grimace et garde-la pendant 15 secondes."
        ];

        const truths = [
            "Quel est le truc le plus bizarre que tu aies mang√© en soir√©e ?",
            "Si tu √©tais un cocktail, lequel serais-tu et pourquoi ?",
            "Quelle est la chose la plus embarrassante que tu aies post√©e sur les r√©seaux sociaux ?",
            "As-tu d√©j√† 'emprunt√©' quelque chose √† un coloc sans le lui dire ? Si oui, quoi ?",
            "Quel est ton plus grand talent cach√© (m√™me si c'est inutile) ?",
            "Si tu pouvais √©changer ta vie avec un personnage de s√©rie t√©l√©, qui choisirais-tu ?",
            "Quelle est la chose la plus folle que tu aies faite pour √©viter d'√©tudier ?",
            "Quel est ton pire souvenir de gueule de bois ?",
            "As-tu d√©j√† fait semblant de comprendre quelque chose alors que tu n'avais aucune id√©e ?",
            "Si tu pouvais avoir un super-pouvoir li√© √† la f√™te, lequel serait-il ?",
            "Quelle est la pire excuse que tu aies donn√©e pour ne pas aller en cours ?",
            "As-tu d√©j√† confondu quelqu'un avec une autre personne en soir√©e ?",
            "Quel est le surnom le plus ridicule que tu aies eu ?",
            "Si tu pouvais voyager dans le temps, √† quelle √©poque irais-tu pour faire la f√™te ?",
            "Quelle est la chose la plus dr√¥le que tu aies vue quelqu'un faire sous l'effet de l'alcool ?",
            "As-tu d√©j√† eu un crush sur un professeur ?",
            "Quel est ton 'guilty pleasure' musical (que tu √©coutes en secret) ?",
            "Si tu devais vivre avec un animal, lequel choisirais-tu et pourquoi ?",
            "Quel est le pire cadeau que tu aies offert ou re√ßu ?",
            "Quelle est la chose la plus inattendue que tu aies apprise sur quelqu'un en soir√©e ?"
        ];


        // Configuration et initialisation de Tone.js pour les sons
        let synth;
        async function setupAudio() {
            if (!synth) {
                await Tone.start(); // D√©marre le contexte audio (n√©cessaire pour la lecture)
                synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: {
                        type: "sine" // Type d'onde pour le son
                    },
                    envelope: {
                        attack: 0.01,
                        decay: 0.2,
                        sustain: 0.1,
                        release: 0.5
                    }
                }).toDestination(); // Connecte le synth√©tiseur √† la sortie audio par d√©faut
            }
        }

        /**
         * Joue un son de c√©l√©bration.
         */
        function playCelebrationSound() {
            if (synth) {
                // Joue un accord simple pour un effet festif
                synth.triggerAttackRelease(["C4", "E4", "G4", "C5"], "8n");
            }
        }

        // Fonction pour changer d'onglet
        function changeTab(tabId) {
            // Masquer tous les contenus d'onglet
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.add('hidden');
            });
            // D√©sactiver tous les boutons d'onglet
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Afficher le contenu de l'onglet s√©lectionn√©
            document.getElementById(`content${tabId}`).classList.remove('hidden');
            // Activer le bouton de l'onglet s√©lectionn√©
            document.getElementById(`tab${tabId}`).classList.add('active');
        }

        // √âcouteurs d'√©v√©nements pour les boutons d'onglet
        tabCounter.addEventListener('click', () => changeTab('Counter'));
        tabObjective.addEventListener('click', () => changeTab('Objective'));
        tabBAC.addEventListener('click', () => changeTab('BAC'));

        // √âcouteurs pour la navigation entre les √©crans
        startButton.addEventListener('click', () => {
            welcomeScreen.classList.add('hidden');
            objectiveSettingScreen.classList.remove('hidden');
            // S'assurer que l'input de l'objectif initial est synchronis√© avec l'objectif actuel
            initialObjectiveInput.value = objective;
            objectiveError.classList.add('hidden'); // Cacher l'erreur au d√©but
        });

        setObjectiveButton.addEventListener('click', () => {
            const newObjective = parseInt(initialObjectiveInput.value);
            if (!isNaN(newObjective) && newObjective > 0) {
                objective = newObjective;
                objectiveInput.value = newObjective; // Synchronise l'input de l'objectif dans l'onglet
                objectiveSettingScreen.classList.add('hidden');
                mainAppScreen.classList.remove('hidden');
                // R√©initialiser les flags de paliers lors du changement d'objectif
                milestone1Reached = false;
                milestone2Reached = false;
                milestone3Reached = false;
                updateDisplay(); // Met √† jour l'affichage et les calculs
                changeTab('Counter'); // Aller √† l'onglet compteur apr√®s avoir d√©fini l'objectif
                objectiveError.classList.add('hidden'); // Cacher l'erreur si valide
            } else {
                objectiveError.classList.remove('hidden'); // Afficher l'erreur
            }
        });

        // √âcouteur d'√©v√©nements pour l'input de l'objectif dans l'onglet
        objectiveInput.addEventListener('input', () => {
            const newObjective = parseInt(objectiveInput.value);
            if (!isNaN(newObjective) && newObjective > 0) {
                if (jagerbombCount >= newObjective) {
                    previousJagerbombCount = jagerbombCount;
                }
                objective = newObjective;
                // R√©initialiser les flags de paliers si l'objectif change et que le compteur est inf√©rieur
                milestone1Reached = false;
                milestone2Reached = false;
                milestone3Reached = false;
                updateGauge(); // Met √† jour la jauge imm√©diatement si l'objectif change
            } else {
                objective = 50;
                objectiveInput.value = 50;
                milestone1Reached = false;
                milestone2Reached = false;
                milestone3Reached = false;
                updateGauge();
            }
        });

        // √âcouteur d'√©v√©nements pour l'input du poids et la checkbox jeune permis
        weightInput.addEventListener('input', updateBacCalculator);
        youngDriverCheckbox.addEventListener('change', updateBacCalculator);

        /**
         * Affiche l'√©cran Action ou V√©rit√©.
         * @param {number} milestoneValue - La valeur du palier qui a √©t√© atteint.
         */
        function showActionOrTruthScreen(milestoneValue) {
            mainAppScreen.classList.add('hidden'); // Masquer l'application principale
            actionOrTruthScreen.style.display = 'flex'; // Afficher l'√©cran Action ou V√©rit√©
            playCelebrationSound(); // Joue un son de c√©l√©bration
            spawnConfettiEmojis(30, window.innerWidth / 2, window.innerHeight / 2, 0.8); // Confettis
            challengeDisplay.textContent = "Choisis ton destin !"; // R√©initialise le texte
        }

        /**
         * Cache l'√©cran Action ou V√©rit√©.
         */
        function hideActionOrTruthScreen() {
            actionOrTruthScreen.style.display = 'none'; // Masquer l'√©cran Action ou V√©rit√©
            mainAppScreen.classList.remove('hidden'); // Afficher l'application principale
            challengeDisplay.textContent = ""; // Efface le d√©fi affich√©
        }

        /**
         * Affiche une action al√©atoire.
         */
        function displayRandomAction() {
            const randomIndex = Math.floor(Math.random() * actions.length);
            challengeDisplay.textContent = `Action : ${actions[randomIndex]}`;
        }

        /**
         * Affiche une v√©rit√© al√©atoire.
         */
        function displayRandomTruth() {
            const randomIndex = Math.floor(Math.random() * truths.length);
            challengeDisplay.textContent = `V√©rit√© : ${truths[randomIndex]}`;
        }

        // √âcouteurs pour les boutons Action/V√©rit√© et FAIT
        actionButton.addEventListener('click', displayRandomAction);
        truthButton.addEventListener('click', displayRandomTruth);
        doneButton.addEventListener('click', hideActionOrTruthScreen);


        /**
         * Met √† jour l'affichage du compteur et de la jauge.
         * D√©clenche √©galement les c√©l√©brations si les paliers ou l'objectif sont atteints.
         */
        function updateDisplay() {
            countDisplay.textContent = jagerbombCount;
            updateGauge(); // Toujours mettre √† jour la jauge
            updateBacCalculator(); // Toujours mettre √† jour le calculateur d'alcool√©mie
            updateNextMilestoneDisplay(); // Mettre √† jour l'affichage du prochain palier

            // D√©clenche la c√©l√©bration des "paliers" (multiples de 50)
            // if (jagerbombCount > 0 && jagerbombCount % 50 === 0 && previousJagerbombCount % 50 !== 0) {
            //     celebrationMessage.textContent = `F√©licitations ! ${jagerbombCount} J√§gerbombs !`;
            //     celebrationMessage.classList.remove('hidden');
            //     setTimeout(() => {
            //         celebrationMessage.classList.add('hidden');
            //     }, 2000); // Dur√©e du message de c√©l√©bration
            //     spawnConfettiEmojis(50, window.innerWidth / 2, window.innerHeight / 2, 0.8); // Confettis standards
            // }

            // D√©clenche les c√©l√©brations pour les paliers de la jauge
            const milestone1Value = Math.round(objective * 0.33);
            const milestone2Value = Math.round(objective * 0.66);
            const milestone3Value = Math.round(objective * 0.90);

            // C√©l√©bration du palier 1
            if (jagerbombCount >= milestone1Value && !milestone1Reached) {
                if (milestone1Value > 0) {
                    showActionOrTruthScreen(milestone1Value); // Affiche l'√©cran Action ou V√©rit√©
                    milestone1Text.classList.add('milestone-text-active');
                    setTimeout(() => milestone1Text.classList.remove('milestone-text-active'), 1000);
                }
                milestone1Reached = true;
            }
            // C√©l√©bration du palier 2
            if (jagerbombCount >= milestone2Value && !milestone2Reached) {
                if (milestone2Value > 0) {
                    showActionOrTruthScreen(milestone2Value); // Affiche l'√©cran Action ou V√©rit√©
                    milestone2Text.classList.add('milestone-text-active');
                    setTimeout(() => milestone2Text.classList.remove('milestone-text-active'), 1000);
                }
                milestone2Reached = true;
            }
            // C√©l√©bration du palier 3
            if (jagerbombCount >= milestone3Value && !milestone3Reached) {
                if (milestone3Value > 0) {
                    showActionOrTruthScreen(milestone3Value); // Affiche l'√©cran Action ou V√©rit√©
                    milestone3Text.classList.add('milestone-text-active');
                    setTimeout(() => milestone3Text.classList.remove('milestone-text-active'), 1000);
                }
                milestone3Reached = true;
            }


            // D√©clenche la c√©l√©bration "objectif atteint" (beaucoup plus festive)
            if (jagerbombCount >= objective && previousJagerbombCount < objective) {
                showUltimateCelebration();
            }

            // Met √† jour le compte pr√©c√©dent pour la prochaine it√©ration
            previousJagerbombCount = jagerbombCount;
        }

        /**
         * Met √† jour le niveau de liquide dans la jauge de la bouteille J√§gerbombs et les paliers.
         */
        function updateGauge() {
            if (objective === 0) {
                liquidLevel.style.height = '0%';
                milestone1.style.bottom = '0%';
                milestone2.style.bottom = '0%';
                milestone3.style.bottom = '0%';
                milestone1Text.textContent = '';
                milestone2Text.textContent = '';
                milestone3Text.textContent = '';
                return;
            }

            const percentage = Math.min(100, (jagerbombCount / objective) * 100);
            liquidLevel.style.height = `${percentage}%`;

            // Calcul et positionnement des 3 paliers
            const milestone1Value = Math.round(objective * 0.33);
            const milestone2Value = Math.round(objective * 0.66);
            const milestone3Value = Math.round(objective * 0.90);

            const m1Bottom = (milestone1Value / objective) * 100;
            const m2Bottom = (milestone2Value / objective) * 100;
            const m3Bottom = (milestone3Value / objective) * 100;

            milestone1.style.bottom = `${Math.min(m1Bottom, 99)}%`; // Limiter √† 99% pour ne pas d√©passer
            milestone2.style.bottom = `${Math.min(m2Bottom, 99)}%`;
            milestone3.style.bottom = `${Math.min(m3Bottom, 99)}%`;

            // Afficher le texte du palier
            milestone1Text.textContent = `${milestone1Value}`;
            milestone2Text.textContent = `${milestone2Value}`;
            milestone3Text.textContent = `${milestone3Value}`;

            // Assurez-vous que les textes des paliers sont toujours visibles
            milestone1Text.style.display = 'block';
            milestone2Text.style.display = 'block';
            milestone3Text.style.display = 'block';
        }

        /**
         * Met √† jour l'affichage du prochain palier sur l'onglet Compteur.
         */
        function updateNextMilestoneDisplay() {
            const milestone1Value = Math.round(objective * 0.33);
            const milestone2Value = Math.round(objective * 0.66);
            const milestone3Value = Math.round(objective * 0.90);

            let nextMilestone = null;
            let remainingJagerbombs = 0;

            if (jagerbombCount < milestone1Value) {
                nextMilestone = milestone1Value;
                remainingJagerbombs = nextMilestone - jagerbombCount;
            } else if (jagerbombCount < milestone2Value) {
                nextMilestone = milestone2Value;
                remainingJagerbombs = nextMilestone - jagerbombCount;
            } else if (jagerbombCount < milestone3Value) {
                nextMilestone = milestone3Value;
                remainingJagerbombs = nextMilestone - jagerbombCount;
            } else if (jagerbombCount < objective) {
                nextMilestone = objective;
                remainingJagerbombs = nextMilestone - jagerbombCount;
            } else {
                nextMilestoneDisplay.textContent = "Objectif atteint !";
                return;
            }

            if (nextMilestone !== null) {
                nextMilestoneDisplay.textContent = `Prochain palier : ${nextMilestone} J√§gerbombs (${remainingJagerbombs} restants)`;
            } else {
                nextMilestoneDisplay.textContent = "Objectif atteint !";
            }
        }


        /**
         * Calcule et affiche l'alcool√©mie estim√©e, le temps de d√©cuvage et le statut de conduite.
         */
        function updateBacCalculator() {
            const weight = parseFloat(weightInput.value); // Poids de l'utilisateur en kg
            const isYoungDriver = youngDriverCheckbox.checked;
            const currentLegalLimit = isYoungDriver ? LEGAL_LIMIT_YOUNG_DRIVER : LEGAL_LIMIT_STANDARD;

            if (isNaN(weight) || weight <= 0) {
                bacDisplay.textContent = "N/A";
                soberUpTimeDisplay.textContent = "N/A";
                drivingStatusDisplay.textContent = "Veuillez entrer votre poids.";
                drivingStatusDisplay.className = "text-2xl sm:text-3xl font-bold text-zinc-400";
                driveTimeDisplay.textContent = "--:--";
                return;
            }

            // Calcul de la masse d'alcool pur par J√§gerbomb
            const alcoholPerJagerbomb_g = JAG_ML * JAG_ABV * ETHANOL_DENSITY;

            // Masse totale d'alcool pur consomm√©e
            const totalAlcohol_g = jagerbombCount * alcoholPerJagerbomb_g;

            // Calcul de l'alcool√©mie (g/L) - Formule de Widmark simplifi√©e pour les hommes
            // Alcool√©mie (g/L) = (Masse d'alcool en g) / (Poids en kg * Facteur r)
            let bac = 0;
            if (weight > 0) {
                bac = totalAlcohol_g / (weight * MALE_R_FACTOR);
            }

            // Affichage de l'alcool√©mie, arrondie √† deux d√©cimales.
            bacDisplay.textContent = bac.toFixed(2);

            // D√©terminer le statut de conduite
            if (bac <= currentLegalLimit) {
                drivingStatusDisplay.textContent = "Vous pouvez conduire";
                drivingStatusDisplay.className = "text-2xl sm:text-3xl font-bold text-green-500";
                soberUpTimeDisplay.textContent = "0h 00m";
                driveTimeDisplay.textContent = "Maintenant";
            } else {
                drivingStatusDisplay.textContent = "Vous ne pouvez PAS conduire";
                drivingStatusDisplay.className = "text-2xl sm:text-3xl font-bold text-red-500";

                // Calcul du temps n√©cessaire pour atteindre la limite l√©gale
                const bacToEliminate = bac - currentLegalLimit;
                let timeToReachLimitHours = 0;
                if (bacToEliminate > 0) {
                    timeToReachLimitHours = bacToEliminate / ELIMINATION_RATE;
                }

                // Conversion du temps de d√©cuvage en heures et minutes
                const hoursSoberUp = Math.floor(timeToReachLimitHours);
                const minutesSoberUp = Math.round((timeToReachLimitHours - hoursSoberUp) * 60);
                soberUpTimeDisplay.textContent = `${hoursSoberUp}h ${minutesSoberUp}m`;

                // Calcul de l'heure √† laquelle on peut conduire
                const currentTime = new Date();
                const futureTime = new Date(currentTime.getTime() + timeToReachLimitHours * 60 * 60 * 1000); // Ajouter les heures en millisecondes

                const driveHours = futureTime.getHours().toString().padStart(2, '0');
                const driveMinutes = futureTime.getMinutes().toString().padStart(2, '0');
                driveTimeDisplay.textContent = `${driveHours}:${driveMinutes}`;
            }
        }

        /**
         * G√©n√®re des emojis festifs qui se dispersent et s'estompent pour simuler des feux d'artifice.
         * @param {number} numEmojis - Le nombre d'emojis √† g√©n√©rer.
         * @param {number} originX - La position X d'o√π les emojis √©clatent.
         * @param {number} originY - La position Y d'o√π les emojis √©clatent.
         * @param {number} spreadFactor - Facteur de dispersion des emojis (plus grand = plus dispers√©).
         */
        function spawnConfettiEmojis(numEmojis = 30, originX = window.innerWidth / 2, originY = window.innerHeight / 2, spreadFactor = 0.8) {
            const emojis = ['üéâ', 'üéÜ', '‚ú®', 'üçæ', 'ü•≥', 'üéä', 'ü•Ç', 'üçª', 'ü•É', 'üëØ']; // Plus d'emojis festifs

            for (let i = 0; i < numEmojis; i++) {
                const emoji = document.createElement('span');
                emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                emoji.classList.add('confetti-emoji');

                // Position initiale des emojis
                const startX = originX;
                const startY = originY;

                // Position cible al√©atoire (dispers√©e) bas√©e sur le facteur de dispersion
                const endX = startX + (Math.random() - 0.5) * window.innerWidth * spreadFactor;
                const endY = startY + (Math.random() - 0.5) * window.innerHeight * spreadFactor;

                // Rotation al√©atoire pour un effet plus naturel
                const rotation = Math.random() * 720 - 360; // De -360 √† 360 degr√©s

                // Applique les variables CSS pour l'animation
                emoji.style.setProperty('--x', `${endX - startX}px`);
                emoji.style.setProperty('--y', `${endY - startY}px`);
                emoji.style.setProperty('--rotate', `${rotation}deg`);

                // D√©lai al√©atoire pour un effet √©chelonn√© des confettis
                emoji.style.animationDelay = `${Math.random() * 0.5}s`;

                fireworksContainer.appendChild(emoji);

                // Supprime l'emoji une fois l'animation termin√©e pour √©viter l'accumulation
                emoji.addEventListener('animationend', () => {
                    emoji.remove();
                });
            }
        }

        /**
         * Affiche la c√©l√©bration ultime en plein √©cran lorsque l'objectif est atteint.
         */
        function showUltimateCelebration() {
            ultimateCelebrationCount.textContent = `${jagerbombCount} J√§gerbombs !`;
            ultimateCelebrationOverlay.classList.remove('hidden');
            ultimateCelebrationOverlay.classList.remove('opacity-0'); // Fait appara√Ætre l'overlay en fondu
            ultimateCelebrationOverlay.classList.add('ultimate-celebration-active'); // Active l'animation de fond

            playCelebrationSound(); // Joue le son de c√©l√©bration

            // D√©clenche une explosion de confettis beaucoup plus grande et plus dispers√©e
            spawnConfettiEmojis(200, window.innerWidth / 2, window.innerHeight / 2, 1.8);

            // Cache l'overlay apr√®s un d√©lai
            setTimeout(() => {
                ultimateCelebrationOverlay.classList.add('opacity-0'); // Fait dispara√Ætre l'overlay en fondu
                ultimateCelebrationOverlay.classList.remove('ultimate-celebration-active'); // D√©sactive l'animation de fond
                ultimateCelebrationOverlay.addEventListener('transitionend', () => {
                    ultimateCelebrationOverlay.classList.add('hidden');
                }, { once: true }); // S'assure que l'√©couteur est retir√© apr√®s une utilisation
            }, 5000); // L'overlay reste visible pendant 5 secondes
        }


        // √âcouteurs d'√©v√©nements pour les boutons d'incr√©mentation
        incrementButton.addEventListener('click', () => {
            previousJagerbombCount = jagerbombCount;
            jagerbombCount++;
            updateDisplay();
        });

        increment5Button.addEventListener('click', () => {
            previousJagerbombCount = jagerbombCount;
            jagerbombCount += 5;
            updateDisplay();
        });

        increment10Button.addEventListener('click', () => {
            previousJagerbombCount = jagerbombCount;
            jagerbombCount += 10;
            updateDisplay();
        });

        increment20Button.addEventListener('click', () => {
            previousJagerbombCount = jagerbombCount;
            jagerbombCount += 20;
            updateDisplay();
        });

        // √âcouteur d'√©v√©nement pour le bouton de remise √† z√©ro
        resetButton.addEventListener('click', () => {
            jagerbombCount = 0;
            previousJagerbombCount = 0; // R√©initialise aussi le compte pr√©c√©dent
            milestone1Reached = false; // R√©initialise les flags des paliers
            milestone2Reached = false;
            milestone3Reached = false;
            updateDisplay();
        });

        // Mise √† jour initiale de l'affichage, de la jauge et initialisation de l'audio au chargement de la page
        window.onload = () => {
            updateDisplay();
            updateGauge();
            setupAudio(); // Initialise le contexte audio
            updateBacCalculator(); // Met √† jour le calculateur d'alcool√©mie au chargement
            
            // Masquer tous les √©crans sauf l'√©cran d'accueil au d√©marrage
            welcomeScreen.classList.remove('hidden');
            objectiveSettingScreen.classList.add('hidden');
            mainAppScreen.classList.add('hidden');
            actionOrTruthScreen.style.display = 'none'; // Assurez-vous que l'√©cran Action ou V√©rit√© est cach√© au d√©marrage
        };
    </script>
</body>
</html>
